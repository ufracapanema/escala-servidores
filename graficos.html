<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Gestão Operacional</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #f1f5f9; --bg-card: white; --texto: #1e293b;
            --primaria: #3b82f6; --p-color: #34495e; --t-color: #10b981;
            --a-color: #ef4444; --c-color: #f1c40f; --f-color: #64748b;
            --bg-item-lista: #f8fafc; --border-item-lista: #f1f5f9;
        }
        [data-theme="dark"] {
            --bg-body: #0f172a; --bg-card: #1e293b; --texto: #f1f5f9;
            --bg-item-lista: #334155; --border-item-lista: #475569;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-body); color: var(--texto); margin: 0; padding: 20px; transition: 0.3s; }
        
        .header { text-align: center; margin-bottom: 20px; }
        .update-info { font-size: 0.85rem; color: #64748b; margin-top: 5px; }

        #theme-toggle { 
            position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; 
            border-radius: 50%; border: none; background: var(--primaria); color: white; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; transition: transform 0.2s;
        }
        .btn-voltar { 
            position: fixed; bottom: 20px; left: 20px; width: 55px; height: 55px; 
            border-radius: 50%; background: #64748b; color: white; text-decoration: none; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; transition: transform 0.2s;
        }
        #theme-toggle:hover, .btn-voltar:hover { transform: scale(1.1); }

        #main-container { display: none; }
        .filters-area { max-width: 1100px; margin: 0 auto 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .filter-box { background: var(--bg-card); padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 8px; }
        select { padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; background: var(--bg-card); color: var(--texto); font-size: 1rem; cursor: pointer; }

        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; max-width: 1200px; margin: 0 auto 30px; }
        .card-stat { background: var(--bg-card); padding: 15px; border-radius: 16px; text-align: center; border-bottom: 4px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-stat h3 { margin: 0; font-size: 0.65rem; text-transform: uppercase; color: #64748b; font-weight: 700; }
        .card-stat p { margin: 10px 0 0; font-size: 1.5rem; font-weight: 800; }
        .card-servidores { border-color: var(--primaria); }
        .card-p { border-color: var(--p-color); } .card-t { border-color: var(--t-color); }
        .card-c { border-color: var(--c-color); } .card-a { border-color: var(--a-color); }
        .card-f { border-color: var(--f-color); }

        .charts-container { display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 1100px; margin: 0 auto 40px; }
        @media (min-width: 768px) { .charts-container { grid-template-columns: 1fr 1.5fr; } }
        .chart-box { background: var(--bg-card); padding: 20px; border-radius: 16px; min-height: 380px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Estilo da Tabela de Horas Reformulada */
        .secao-horas { max-width: 1100px; margin: 0 auto 40px; background: var(--bg-card); padding: 20px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .secao-horas h2 { font-size: 1rem; margin-bottom: 15px; text-align: center; color: var(--primaria); }
        .tabela-horas { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .tabela-horas th { text-align: left; padding: 10px; border-bottom: 2px solid var(--border-item-lista); color: #64748b; }
        .tabela-horas td { padding: 8px 10px; border-bottom: 1px solid var(--border-item-lista); }
        .turno-row { background: var(--bg-body); font-weight: bold; color: var(--primaria); }
        .turno-info { font-weight: normal; font-size: 0.75rem; color: #64748b; margin-left: 10px; }
        .resumo-geral { margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--primaria); display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .resumo-item { font-size: 0.8rem; font-weight: bold; }

        .lista-detalhada { max-width: 1200px; margin: 0 auto 100px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .coluna-lista { background: var(--bg-card); border-radius: 12px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-top: 4px solid; }
        .coluna-p { border-top-color: var(--p-color); } .coluna-t { border-top-color: var(--t-color); }
        .coluna-c { border-top-color: var(--c-color); } .coluna-a { border-top-color: var(--a-color); }
        .coluna-f { border-top-color: var(--f-color); }
        .coluna-lista h4 { margin: 0 0 15px; font-size: 0.8rem; text-transform: uppercase; display: flex; justify-content: space-between; color: var(--texto); }
        .coluna-lista ul { list-style: none; padding: 0; margin: 0; }
        .coluna-lista li { padding: 8px 12px; font-size: 0.8rem; border-bottom: 1px solid var(--border-item-lista); background: var(--bg-item-lista); color: var(--texto); margin-bottom: 4px; border-radius: 4px; }
        .loader { text-align: center; padding: 100px 20px; font-weight: bold; font-size: 1.2rem; }
    </style>
</head>
<body>

    <a href="index.html" class="btn-voltar" title="Voltar">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
    </a>

    <button id="theme-toggle" title="Alternar Modo Claro/Escuro">
        <svg id="theme-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg>
    </button>

    <div class="header">
        <h1>Dashboard de Gestão Operacional</h1>
        <div id="timestamp" class="update-info">Sincronizando dados...</div>
    </div>

    <div id="loading" class="loader">
        <div style="margin-bottom: 20px;">⚡ Carregando informações da Escala...</div>
    </div>

    <div id="main-container">
        <div class="filters-area">
            <div class="filter-box">
                <label><strong>1. Turno:</strong></label>
                <select id="select-turno">
                    <option value="todos">Todos os Turnos</option>
                    <option value="0">Turno da Manhã</option>
                    <option value="1">Turno da Tarde</option>
                    <option value="2">Turno da Noite</option>
                </select>
            </div>
            <div class="filter-box">
                <label><strong>2. Dia da Semana:</strong></label>
                <select id="select-dia">
                    <option value="0">Segunda-feira</option>
                    <option value="1">Terça-feira</option>
                    <option value="2">Quarta-feira</option>
                    <option value="3">Quinta-feira</option>
                    <option value="4">Sexta-feira</option>
                </select>
            </div>
        </div>

        <div class="grid-stats">
            <div class="card-stat card-servidores"><h3>Servidores</h3><p id="stat-total">0</p></div>
            <div class="card-stat card-p"><h3>Presencial</h3><p id="stat-p">0</p></div>
            <div class="card-stat card-t"><h3>Teletrabalho</h3><p id="stat-t">0</p></div>
            <div class="card-stat card-c"><h3>Chefia</h3><p id="stat-c">0</p></div>
            <div class="card-stat card-a"><h3>Afastados</h3><p id="stat-a">0</p></div>
            <div class="card-stat card-f"><h3>Fora do Turno</h3><p id="stat-f">0</p></div>
        </div>

        <div class="charts-container">
            <div class="chart-box"><canvas id="chartPizzaHoje"></canvas></div>
            <div class="chart-box"><canvas id="chartSemanal"></canvas></div>
        </div>

        <div class="secao-horas">
            <h2>Carga Horária e Atendimento</h2>
            <table class="tabela-horas">
                <thead>
                    <tr>
                        <th>Servidor</th>
                        <th>Horário Efetivo</th>
                        <th style="text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela-horas"></tbody>
            </table>
            
            <div class="resumo-geral" id="resumo-horas">
                </div>
        </div>

        <div class="lista-detalhada">
            <div class="coluna-lista coluna-p"><h4>Presencial <span id="count-p">0</span></h4><ul id="list-p"></ul></div>
            <div class="coluna-lista coluna-t"><h4>Teletrabalho <span id="count-t">0</span></h4><ul id="list-t"></ul></div>
            <div class="coluna-lista coluna-c"><h4>Chefia <span id="count-c">0</span></h4><ul id="list-c"></ul></div>
            <div class="coluna-lista coluna-a"><h4>Afastados <span id="count-a">0</span></h4><ul id="list-a"></ul></div>
            <div class="coluna-lista coluna-f"><h4>Fora do Turno <span id="count-f">0</span></h4><ul id="list-f"></ul></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzHe6FYRN5bwebFslDF-pecwnUWpY9WXDF_Nl9V1sYncbwfIVmZ0k-Mqu6WUDNoYZtZxw/exec';
        let database = {}; 
        let charts = {};

        const sunIcon = `<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22">`;
        const moonIcon = `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z">`;

        function calcularDiferencaHoras(texto) {
            if (!texto || !texto.includes('|')) return 0;
            try {
                const partes = texto.split('|').map(p => p.trim());
                const conv = (h) => { const [hrs, mins] = h.split(':').map(Number); return (hrs * 60) + mins; };
                return (conv(partes[1]) - conv(partes[0])) / 60;
            } catch (e) { return 0; }
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('theme-icon').innerHTML = theme === 'dark' ? sunIcon : moonIcon;
            localStorage.setItem('theme', theme);
            if (Object.keys(database).length > 0) processar();
        }

        setTheme(localStorage.getItem('theme') || 'light');
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            setTheme(current === 'dark' ? 'light' : 'dark');
        });

        async function init() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                const rows = data.slice(1);
                
                for (let i = 0; i < rows.length; i += 3) {
                    const nome = rows[i] ? rows[i][2] : null;
                    if (nome && !nome.includes('@')) {
                        const blocos = [rows[i], rows[i+1], rows[i+2]];
                        
                        // LÓGICA DE EXCLUSÃO: Só adiciona se tiver horário OU algum status P,T,C,A
                        const temDado = blocos.some(l => {
                            if (!l) return false;
                            const temH = l[3] && l[3].toString().trim() !== "";
                            let temS = false;
                            for(let d=0; d<5; d++) if(['P','T','C','A'].includes(l[6+d]?.toString().toUpperCase().trim())) temS = true;
                            return temH || temS;
                        });

                        if (temDado) database[nome] = blocos;
                    }
                }

                const hoje = new Date().getDay();
                document.getElementById('select-dia').value = (hoje >= 1 && hoje <= 5) ? hoje - 1 : 0;
                document.getElementById('select-turno').addEventListener('change', processar);
                document.getElementById('select-dia').addEventListener('change', processar);

                processar();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
            } catch (e) { document.getElementById('loading').innerHTML = "❌ Erro ao carregar."; }
        }

        function processar() {
            const turnoFiltro = document.getElementById('select-turno').value;
            const diaFiltro = parseInt(document.getElementById('select-dia').value);
            let semanal = { P: [0,0,0,0,0], T: [0,0,0,0,0], C: [0,0,0,0,0], A: [0,0,0,0,0], F: [0,0,0,0,0] };
            let nomesNoDia = { P: [], T: [], C: [], A: [], F: [] };
            let horasPorTurno = [[], [], []];
            let somaTurnos = [0, 0, 0];

            Object.keys(database).forEach(nome => {
                const blocos = database[nome];
                const temHorarioFixo = blocos.some(l => l && l[3] && l[3].toString().trim() !== "");

                for (let d = 0; d < 5; d++) {
                    let statusDoDia = new Set();
                    blocos.forEach((linha, idx) => {
                        if (!linha) return;
                        const s = linha[6 + d]?.toString().toUpperCase().trim();
                        const passaFiltro = (!temHorarioFixo) || (turnoFiltro === 'todos' || turnoFiltro == idx);

                        if (['P', 'T', 'C', 'A'].includes(s) && passaFiltro) {
                            statusDoDia.add(s);
                            if (d === diaFiltro && (turnoFiltro === 'todos' || turnoFiltro == idx)) {
                                const hStr = linha[3]?.toString() || "";
                                const hVal = calcularDiferencaHoras(hStr);
                                if (hVal > 0) {
                                    horasPorTurno[idx].push({ nome, hStr, hVal });
                                    somaTurnos[idx] += hVal;
                                }
                            }
                        }
                    });

                    let sf = 'F';
                    if (statusDoDia.has('A')) sf = 'A'; else if (statusDoDia.has('C')) sf = 'C';
                    else if (statusDoDia.has('P')) sf = 'P'; else if (statusDoDia.has('T')) sf = 'T';

                    semanal[sf][d]++;
                    if (d === diaFiltro) nomesNoDia[sf].push(nome);
                }
            });

            // Renderizar Tabela
            const labels = ["TURNO MANHÃ", "TURNO TARDE", "TURNO NOITE"];
            const horarios = ["07:00 | 13:00", "13:00 | 19:00", "19:00 | 01:00"];
            let htmlTable = "";
            horasPorTurno.forEach((lista, idx) => {
                if (lista.length > 0) {
                    htmlTable += `<tr class="turno-row"><td colspan="3">${labels[idx]} <span class="turno-info">Atendimento: ${horarios[idx]}</span></td></tr>`;
                    lista.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(item => {
                        htmlTable += `<tr><td>${item.nome}</td><td>${item.hStr}</td><td style="text-align: right;">${item.hVal.toFixed(1)}h</td></tr>`;
                    });
                }
            });
            document.getElementById('corpo-tabela-horas').innerHTML = htmlTable || '<tr><td colspan="3">Sem registros.</td></tr>';

            // Resumo Geral
            const totalGeral = somaTurnos.reduce((a, b) => a + b, 0);
            document.getElementById('resumo-horas').innerHTML = `
                <div class="resumo-item" style="color:var(--primaria)">Manhã: ${somaTurnos[0].toFixed(1)}h</div>
                <div class="resumo-item" style="color:var(--t-color)">Tarde: ${somaTurnos[1].toFixed(1)}h</div>
                <div class="resumo-item" style="color:var(--h-color, #8e44ad)">Noite: ${somaTurnos[2].toFixed(1)}h</div>
                <div class="resumo-item" style="border-left: 2px solid #ccc; padding-left:10px">TOTAL GERAL: ${totalGeral.toFixed(1)}h</div>
            `;

            document.getElementById('stat-total').innerText = Object.keys(database).length;
            ['p', 't', 'c', 'a', 'f'].forEach(k => {
                const U = k.toUpperCase();
                document.getElementById(`stat-${k}`).innerText = semanal[U][diaFiltro];
                document.getElementById(`count-${k}`).innerText = `(${nomesNoDia[U].length})`;
                document.getElementById(`list-${k}`).innerHTML = nomesNoDia[U].length ? nomesNoDia[U].sort().map(n => `<li>${n}</li>`).join('') : '<li>-</li>';
            });
            renderCharts(semanal, diaFiltro);
        }

        function renderCharts(vol, diaSel) {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const labelColor = isDark ? '#f1f5f9' : '#475569';
            if (charts.pizza) charts.pizza.destroy();
            if (charts.bar) charts.bar.destroy();

            charts.pizza = new Chart(document.getElementById('chartPizzaHoje'), {
                type: 'pie',
                data: {
                    labels: ['P', 'T', 'C', 'A', 'F'],
                    datasets: [{
                        data: [vol.P[diaSel], vol.T[diaSel], vol.C[diaSel], vol.A[diaSel], vol.F[diaSel]],
                        backgroundColor: ['#34495e', '#10b981', '#f1c40f', '#ef4444', '#64748b']
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: labelColor } } } }
            });

            charts.bar = new Chart(document.getElementById('chartSemanal'), {
                type: 'bar',
                data: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex'],
                    datasets: [
                        { label: 'Presencial', data: vol.P, backgroundColor: '#34495e' },
                        { label: 'Teletrabalho', data: vol.T, backgroundColor: '#10b981' },
                        { label: 'Chefia', data: vol.C, backgroundColor: '#f1c40f' },
                        { label: 'Afastado', data: vol.A, backgroundColor: '#ef4444' }
                    ]
                },
                options: { maintainAspectRatio: false, scales: { x: { stacked: true, ticks: { color: labelColor } }, y: { stacked: true, ticks: { color: labelColor } } } }
            });
        }
        init();
    </script>
</body>
</html>
