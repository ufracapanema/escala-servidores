<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Férias Ativas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Inter', sans-serif; }
        .search-container { background: white; padding: 20px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 30px; }
        .setor-title { padding: 8px 20px; border-radius: 50px; color: white; font-weight: 700; display: inline-block; margin-bottom: 20px; font-size: 0.9rem; text-transform: uppercase; }
        
        /* Card do Servidor */
        .servidor-card { 
            background: white; border: 1px solid #eee; border-radius: 12px; 
            height: 100%; padding: 20px; transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        
        /* Destaque para quem está de férias hoje */
        .em-ferias-hoje { 
            border: 2px solid #198754 !important; 
            box-shadow: 0 0 15px rgba(25, 135, 84, 0.2);
        }
        .selo-ativo { 
            position: absolute; top: 0; right: 0; background: #198754; color: white;
            font-size: 0.65rem; padding: 4px 10px; font-weight: 800; border-bottom-left-radius: 10px;
        }

        .nome-servidor { font-weight: 800; color: #2d3436; margin-bottom: 15px; font-size: 1.1rem; }
        .data-box { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 5px; }
        .data-label { font-size: 0.7rem; font-weight: 700; color: #636e72; text-transform: uppercase; display: block; }
        .data-valor { font-size: 0.95rem; color: #2d3436; font-weight: 600; }
        .badge-dias { background: #2d3436; color: white; border-radius: 6px; padding: 4px 8px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center text-center mb-4">
        <div class="col-md-8">
            <h1 class="fw-bold text-dark">Escala de Férias Atualizada</h1>
            <p class="text-muted">Visualizando apenas períodos vigentes ou futuros</p>
        </div>
    </div>

    <div class="search-container">
        <div class="input-group">
            <span class="input-group-text bg-transparent border-0"><i class="bi bi-search"></i></span>
            <input type="text" id="inputBusca" class="form-control border-0 shadow-none" placeholder="Filtrar por nome ou setor...">
        </div>
    </div>

    <div id="painelSetores"></div>
</div>

<script>
    const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKegsnxIiUPRWL3KMa9vgqmZJB3hCS9hSavAAYo3FYyOiegdGPoJJQOQ-vGbmumbEsNy2DUFxgDb2c/pub?output=csv";
    
    // Leque de cores primárias e secundárias
    const lequeCores = ["#0d6efd", "#6610f2", "#6f42c1", "#d63384", "#dc3545", "#fd7e14", "#ffc107", "#198754", "#20c997", "#0dcaf0"];
    const coresAtribuidas = {};
    let corIndex = 0;

    async function iniciar() {
        try {
            const res = await fetch(url + "&t=" + Date.now());
            const csv = await res.text();
            const hoje = new Date();
            hoje.setHours(0,0,0,0);

            const linhas = csv.split(/\r?\n/).filter(l => l.trim() !== "").slice(1);
            
            const dados = linhas.map(l => {
                const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
                const dInicio = converterData(c[1]);
                const dFim = converterData(c[2]);
                return {
                    nome: c[0], inicioStr: c[1], fimStr: c[2],
                    inicioObj: dInicio, fimObj: dFim, setor: c[3] || 'Geral',
                    dias: Math.ceil(Math.abs(dFim - dInicio) / (86400000)) + 1,
                    estaDeFerias: (hoje >= dInicio && hoje <= dFim),
                    expirado: hoje > dFim
                };
            }).filter(item => !item.expirado); // REMOVE O QUE JÁ PASSOU

            renderizar(dados);

            document.getElementById('inputBusca').addEventListener('input', e => {
                const termo = e.target.value.toLowerCase();
                renderizar(dados.filter(s => s.nome.toLowerCase().includes(termo) || s.setor.toLowerCase().includes(termo)));
            });

        } catch (e) { console.error(e); }
    }

    function converterData(s) {
        const p = s.split('/');
        return new Date(p[2], p[1]-1, p[0]);
    }

    function renderizar(dados) {
        const container = document.getElementById('painelSetores');
        container.innerHTML = "";
        
        const grupos = dados.reduce((acc, s) => {
            acc[s.setor] = acc[s.setor] || [];
            acc[s.setor].push(s);
            return acc;
        }, {});

        Object.keys(grupos).sort().forEach(setor => {
            // Atribuição dinâmica de cores do leque
            if (!coresAtribuidas[setor]) {
                coresAtribuidas[setor] = lequeCores[corIndex % lequeCores.length];
                corIndex++;
            }

            const servidores = grupos[setor].sort((a,b) => a.inicioObj - b.inicioObj);
            let html = `<div><span class="setor-title" style="background:${coresAtribuidas[setor]}">${setor}</span><div class="row g-3 mb-5">`;

            servidores.forEach(s => {
                html += `
                    <div class="col-xl-3 col-lg-4 col-md-6">
                        <div class="servidor-card ${s.estaDeFerias ? 'em-ferias-hoje' : ''}">
                            ${s.estaDeFerias ? '<div class="selo-ativo">EM FÉRIAS AGORA</div>' : ''}
                            <div class="nome-servidor">${s.nome}</div>
                            <div class="data-box">
                                <span class="data-label">Início</span>
                                <span class="data-valor">${s.inicioStr}</span>
                            </div>
                            <div class="data-box">
                                <span class="data-label">Fim</span>
                                <span class="data-valor">${s.fimStr}</span>
                            </div>
                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                <span class="text-muted small">Duração:</span>
                                <span class="badge-dias">${s.dias} dias</span>
                            </div>
                        </div>
                    </div>`;
            });
            container.innerHTML += html + `</div></div>`;
        });
    }

    iniciar();
</script>
</body>
</html>
